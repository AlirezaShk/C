<?php
$page = isset($_GET['page-id']) ? $_GET['page-id'] : 1;
$limit_per_page = isset($_GET['limit']) ? (int) $_GET['limit'] : 50;
$video_source = 'all';

$selected = ['','','','',''];
$type = NULL;
if(isset($_GET['type'])) {
    switch ($_GET['type']) {
        case 0: $type = Report::TYPE_REPORT; $selected[0] = 'selected'; break;
        case 1: $type = Report::TYPE_CONTACT; $selected[1] = 'selected'; break;
        case 2: $type = Report::TYPE_CHREQ; $selected[2] = 'selected'; break;
        case 3: $type = Report::TYPE_VREQ; $selected[3] = 'selected'; break;
        case 4: $type = Report::TYPE_OTHER; $selected[4] = 'selected'; break;
        default: $type = NULL;
    }
}
$reports = new Report();
if (!is_null($type)) $records = $reports->getAllByType($type);
else $records = $reports->getAll();
?>
<div class="container-fluid">
    <div class="block-header">
        <h2>Videos > <a href="<?php echo PT_LoadAdminLinkSettings('manage-reports') ?>">Manage Reports</a> <small><?= count((array) $records) ?> TOTAL RECORDS</small></h2>

    </div>
    <!-- Vertical Layout -->
    <div class="row">
        <div class="col-lg-12 col-md-12">
            <div class="card">
                <div class="header">
                    <h2>Manage & Edit Records</h2>
                </div>
                <div class="body">
                   <div class="row">
                       <form action="<?php echo PT_LoadAdminLinkSettings('manage-reports'); ?>" method="get">
                            <div class=" clearfix">
                                <div class="col-lg-2 col-md-2">
                                    <select class="form-control show-tick" id="admin" name="admin">
                                        <option value="5" selected>All</option>
                                        <option value="0"<?= $selected[0];?>>Reports</option>
                                        <option value="1"<?= $selected[1];?>>Contacts</option>
                                        <option value="2"<?= $selected[2];?>>Channel Requests</option>
                                        <option value="3"<?= $selected[3];?>>Verification Requests</option>
                                        <option value="4"<?= $selected[4];?>>Others</option>
                                    </select>
                                </div>
                                <div class="col-lg-2 col-md-2">
                                    <button type="submit" class="btn btn-primary btn-lg m-l-10 waves-effect">SEARCH</button>
                                </div>
                            </div>
                        </form>
                   </div>
                   <div class="clearfix"></div>
                   <div class="table-responsive1">
                        <table class="table table-bordered table-striped table-hover">
                            <thead>
                                <tr>
                                      <th><input type="checkbox" id="check-all" class="filled-in check-all" ><label for="check-all"></label></th>
                                      <th>ID</th>
					                  <th>Type</th>
					                  <th>User</th>
					                  <th>Datetime</th>
                                      <th>Status</th>
                                      <th>Supervision Date</th>
                                </tr>
                            </thead>
                            <tbody>
                                <?php
                                foreach ($records as $record) {
                                    $user_string = 'Not Signed';
                                    if (!is_null($record['user_id'])) {
                                        $um = new User();
                                        $user_info = $um->getOne(intval($record['user_id']), User::BY_ID);
                                        $user_string = '<a href="'.$site_url . '/@' . $user_info['username'] .'"><img src="' . $user_info['avatar'] .'" class="td-avatar" alt="user avatar">' . $user_info['first_name'] . ' ' . $user_info['last_name'] .'</a>';
                                    }
                                	echo PT_LoadAdminPage('manage-reports/list', [
                                        'ID' => $record['id'],
                                        'TYPE' => $record['type'],
                                        'USER_' => $user_string,
                                        'DATETIME' => Date('Y/m/d H:i:s', intval($record['time'])),
                                        'STATUS' => Report::STATUS[intval($record['status'])],
                                        'SUPERVISED' => (
                                                !is_null($record['seenTime']) ?
                                                    Date('Y/m/d H:i:s', intval($record['seenTime'])) :
                                                    'NEVER'
                                        )
                                    ]);
                                }
                                ?>
                            </tbody>
                        </table>
                        <?php if (count($records) == 0) { ?>
                           <div class="no-data-found">
                               No records found
                           </div>
                        <?php } ?>
                    </div>
                </div>
            </div>
        </div>
        <div class="clearfix"></div>
    </div>
    <!-- #END# Vertical Layout -->
<div id="delete-modal" class="modal fade" role="dialog" data-id="">
  <div class="modal-dialog">
    <div class="modal-content modal-col-red">
      <div class="modal-header">
        <button type="button" class="close" data-dismiss="modal">&times;</button>
        <h4 class="modal-title">DELETE RECORD</h4>
      </div>
      <div class="modal-body">
        <p>Are you sure you want to continue? this action can't be undo</p>
      </div>
      <div class="modal-footer">
      	<button type="button" class="btn btn-link waves-effect delete-button" data-dismiss="modal" data-type="video">DELETE</button>
        <button type="button" class="btn btn-link waves-effect" data-dismiss="modal">CLOSE</button>
      </div>
    </div>
  </div>
</div>
<script>
$(document).on('click', '.approve-content', function(event) {
    event.preventDefault();
    $video_id_approve = $(this).attr('data-id');
    $('#list-' + $video_id_approve).find('.approve-content').removeClass('btn-success').addClass('btn-default').removeClass('approve-content').addClass('disapprove-content').text('Disapporve');
    $.post('{{LINK aj/ap/videos-status}}', {id: $video_id_approve, status:'approve'}, function(data, textStatus, xhr) {
        /*optional stuff to do after success */
    });
});
$(document).on('click', '.disapprove-content', function(event) {
    event.preventDefault();
    $video_id_approve = $(this).attr('data-id');
    $('#list-' + $video_id_approve).find('.disapprove-content').addClass('btn-success').removeClass('btn-default').removeClass('disapprove-content').addClass('approve-content').text('Approve');
    $.post('{{LINK aj/ap/videos-status}}', {id: $video_id_approve, status:'disapporve'}, function(data, textStatus, xhr) {
        /*optional stuff to do after success */
    });
});
$(function () {
    
	$('.delete-content').on('click', function(event) {
		event.preventDefault();
		$('#delete-modal').attr('data-id', $(this).attr('data-id')).modal('show');
	});
    $('.check-all').on('click', function(event) {
        $('input:checkbox').not(this).prop('checked', this.checked);
    });
    $('.delete-checkbox, .check-all').change(function(event) {
        $('.delete-selected').attr('disabled', false);
        $('.delete-selected').find('span').text(' (' + $('.delete-checkbox:checked').size() + ')');
    });
    $('.delete-selected').on('click', function(event) {
        event.preventDefault();
        data = new Array();
        $('td input:checked').parents('tr').each(function () {
            data.push($(this).attr('data-id'));
        });
        if (confirm('Are you sure that you want to delete the selected video(s)?')) {
            $('.delete-selected').attr('disabled', true);
            $('.delete-selected').text('Please wait..');
            $.post('{{LINK aj/ap/delete-multi-videos}}', {ids: data}, function () {
                alert('Video successfully deleted!');
                $.each( data, function( index, value ){
                    $('#list-' + value).remove();
                });
                $('.delete-selected').text('DELETE SELECTED');
            });
        }
    });
});
</script>